groups:
  - name: portfolio_analytics_alerts
    rules:
      # Analytics Service Health Alerts
      - alert: AnalyticsServiceDown
        expr: up{job="portfolio_analytics"} == 0
        for: 1m
        labels:
          severity: critical
          service: analytics
        annotations:
          summary: "Analytics service is down"
          description: "Analytics service has been down for more than 1 minute"

      - alert: AnalyticsServiceUnhealthy
        expr: analytics_service_health_status != 1
        for: 2m
        labels:
          severity: warning
          service: analytics
        annotations:
          summary: "Analytics service is unhealthy"
          description: "Analytics service health check is failing for more than 2 minutes"

      # Performance Alerts
      - alert: AnalyticsHighResponseTime
        expr: analytics_request_duration_seconds{quantile="0.95"} > 30
        for: 5m
        labels:
          severity: warning
          service: analytics
        annotations:
          summary: "Analytics service high response time"
          description: "95th percentile response time is above 30 seconds for more than 5 minutes"

      - alert: AnalyticsHighErrorRate
        expr: rate(analytics_requests_total{status=~"5.."}[5m]) / rate(analytics_requests_total[5m]) > 0.1
        for: 3m
        labels:
          severity: critical
          service: analytics
        annotations:
          summary: "Analytics service high error rate"
          description: "Error rate is above 10% for more than 3 minutes"

      # Resource Usage Alerts
      - alert: AnalyticsHighMemoryUsage
        expr: analytics_memory_usage_bytes / analytics_memory_limit_bytes > 0.9
        for: 5m
        labels:
          severity: warning
          service: analytics
        annotations:
          summary: "Analytics service high memory usage"
          description: "Memory usage is above 90% for more than 5 minutes"

      - alert: AnalyticsHighCPUUsage
        expr: rate(analytics_cpu_usage_seconds_total[5m]) > 0.8
        for: 10m
        labels:
          severity: warning
          service: analytics
        annotations:
          summary: "Analytics service high CPU usage"
          description: "CPU usage is above 80% for more than 10 minutes"

      # Database Connection Alerts
      - alert: AnalyticsDatabaseConnectionFailed
        expr: analytics_database_connection_status != 1
        for: 1m
        labels:
          severity: critical
          service: analytics
        annotations:
          summary: "Analytics database connection failed"
          description: "Analytics service cannot connect to database for more than 1 minute"

      # Cache Alerts
      - alert: AnalyticsCacheConnectionFailed
        expr: analytics_cache_connection_status != 1
        for: 2m
        labels:
          severity: warning
          service: analytics
        annotations:
          summary: "Analytics cache connection failed"
          description: "Analytics service cannot connect to Redis cache for more than 2 minutes"

      - alert: AnalyticsHighCacheEvictionRate
        expr: rate(analytics_cache_evictions_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          service: analytics
        annotations:
          summary: "High cache eviction rate"
          description: "Cache eviction rate is above 10 per second for more than 5 minutes"

      # Task Processing Alerts
      - alert: AnalyticsTaskQueueBacklog
        expr: analytics_task_queue_size > 100
        for: 5m
        labels:
          severity: warning
          service: analytics
        annotations:
          summary: "Analytics task queue backlog"
          description: "Task queue has more than 100 pending tasks for more than 5 minutes"

      - alert: AnalyticsTaskFailureRate
        expr: rate(analytics_tasks_failed_total[5m]) / rate(analytics_tasks_total[5m]) > 0.2
        for: 3m
        labels:
          severity: critical
          service: analytics
        annotations:
          summary: "High analytics task failure rate"
          description: "Task failure rate is above 20% for more than 3 minutes"

      # Backtest Specific Alerts
      - alert: AnalyticsBacktestTimeout
        expr: analytics_backtest_duration_seconds > 1800
        for: 0m
        labels:
          severity: warning
          service: analytics
        annotations:
          summary: "Analytics backtest taking too long"
          description: "Backtest has been running for more than 30 minutes"

      # Monte Carlo Specific Alerts
      - alert: AnalyticsMonteCarloTimeout
        expr: analytics_monte_carlo_duration_seconds > 3600
        for: 0m
        labels:
          severity: warning
          service: analytics
        annotations:
          summary: "Monte Carlo simulation taking too long"
          description: "Monte Carlo simulation has been running for more than 1 hour"

  - name: portfolio_analytics_worker_alerts
    rules:
      # Worker Health Alerts
      - alert: AnalyticsWorkerDown
        expr: up{job="portfolio_analytics", component="analytics-worker"} == 0
        for: 2m
        labels:
          severity: critical
          service: analytics-worker
        annotations:
          summary: "Analytics worker is down"
          description: "Analytics worker has been down for more than 2 minutes"

      - alert: AnalyticsWorkerHighLoad
        expr: analytics_worker_active_tasks / analytics_worker_max_tasks > 0.9
        for: 10m
        labels:
          severity: warning
          service: analytics-worker
        annotations:
          summary: "Analytics worker high load"
          description: "Worker is at more than 90% capacity for more than 10 minutes"

      - alert: AnalyticsWorkerMemoryLeak
        expr: increase(analytics_worker_memory_usage_bytes[1h]) > 100000000  # 100MB increase per hour
        for: 0m
        labels:
          severity: warning
          service: analytics-worker
        annotations:
          summary: "Potential memory leak in analytics worker"
          description: "Worker memory usage increased by more than 100MB in the last hour"

  - name: portfolio_system_alerts
    rules:
      # System Integration Alerts
      - alert: PortfolioServiceIntegrationFailure
        expr: analytics_external_service_errors_total{service="data_fetcher"} > 10
        for: 5m
        labels:
          severity: warning
          service: analytics
        annotations:
          summary: "Analytics service integration failure"
          description: "Analytics service is experiencing integration issues with external services"

      - alert: PortfolioDataStaleness
        expr: time() - analytics_last_data_update_timestamp > 86400  # 24 hours
        for: 0m
        labels:
          severity: warning
          service: analytics
        annotations:
          summary: "Portfolio data is stale"
          description: "Analytics service hasn't received fresh data in more than 24 hours"